<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- DEINE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDiqf5q8xmyuBO_wTNzW_gV3t-FdZ6kYzc",
            authDomain: "battleroyalegame-a15b2.firebaseapp.com",
            databaseURL: "https://battleroyalegame-a15b2-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "battleroyalegame-a15b2",
            storageBucket: "battleroyalegame-a15b2.firebasestorage.app",
            messagingSenderId: "294232206552",
            appId: "1:294232206552:web:d7c887e38e03e08361fbad",
            measurementId: "G-JBJKLZ0K5X"
        };

        // HIER WAR DER FEHLER: Der Name muss admin_pannel_flo sein!
        // Da du lokal testest, nutzen wir 127.0.0.1
        const SERVER_BASE_URL = "http://127.0.0.1:30120/admin_pannel_flo"; 
        const API_SECRET = "mein_geheimes_passwort_123"; // Muss mit server.lua übereinstimmen!

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH ---
        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                // Zeigt genau an, was falsch ist
                console.error(err);
                document.getElementById('login-msg').innerText = "Fehler: " + err.code; 
            });
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            const loginScreen = document.getElementById('login-screen');
            const dashboard = document.getElementById('dashboard');
            
            if(user) {
                loginScreen.classList.add('hidden');
                dashboard.style.display = 'flex';
                dashboard.classList.remove('hidden');
                fetchPlayers(); // Sofort Spieler laden
                loadTodos();
                // Startet automatischen Refresh alle 5 Sekunden
                setInterval(fetchPlayers, 5000); 
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        // --- NAVIGATION ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('page-' + tabName).classList.add('active');
        }

        // --- PLAYER LOGIC ---
        let allPlayers = [];

        window.fetchPlayers = async () => {
            try {
                // Wir rufen jetzt den richtigen Ordner auf
                console.log("Versuche Spieler zu laden von:", SERVER_BASE_URL + "/players");
                
                const res = await fetch(SERVER_BASE_URL + "/players");
                
                if(!res.ok) throw new Error("HTTP Fehler: " + res.status);
                
                allPlayers = await res.json();
                renderPlayers(allPlayers);
            } catch(e) {
                console.error("Fetch Fehler:", e);
                document.getElementById('playerList').innerHTML = `<li style="padding:20px; text-align:center; color:#ef4444;">Fehler: ${e.message}<br><small>Prüfe F12 Konsole</small></li>`;
            }
        };

        window.renderPlayers = (players) => {
            const list = document.getElementById('playerList');
            list.innerHTML = "";
            if(players.length === 0) {
                 list.innerHTML = '<li style="padding:20px; text-align:center; color:gray;">Keine Spieler online</li>';
                 return;
            }
            players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `<div><span class="status-dot"></span> [${p.id}] ${p.name}</div> <i class="fas fa-chevron-right" style="color:#64748b"></i>`;
                li.onclick = () => selectPlayer(p.id, p.name, li);
                list.appendChild(li);
            });
        };

        window.filterPlayers = () => {
            const term = document.getElementById('playerSearch').value.toLowerCase();
            const filtered = allPlayers.filter(p => p.name.toLowerCase().includes(term) || p.id.toString().includes(term));
            renderPlayers(filtered);
        };

        window.selectPlayer = (id, name, element) => {
            document.querySelectorAll('.player-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedPlayerName').innerText = `Verwalte: ${name} (ID: ${id})`;
            document.getElementById('selectedPlayerName').style.color = "white";
            document.getElementById('selectedPlayerId').value = id;
            document.getElementById('actionPanel').style.opacity = "1";
            document.getElementById('actionPanel').style.pointerEvents = "all";
        };

        window.sendAction = async (actionType) => {
            const id = document.getElementById('selectedPlayerId').value;
            if(!id) return;

            const payload = {
                secret: API_SECRET,
                action: actionType,
                targetId: id
            };

            if(actionType === 'giveitem') {
                payload.item = document.getElementById('itemName').value;
                payload.amount = document.getElementById('itemAmount').value;
            } else if (actionType === 'givemoney') {
                payload.amount = document.getElementById('moneyAmount').value;
                payload.item = 'money'; 
            } else if (actionType === 'giveweapon') {
                payload.item = document.getElementById('weaponName').value;
                payload.amount = document.getElementById('weaponAmmo').value;
            }

            try {
                const res = await fetch(SERVER_BASE_URL + "/command", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                alert(data.message || "Aktion ausgeführt!");
            } catch(e) {
                alert("Fehler beim Senden: " + e.message);
            }
        };

        // --- TODO LOGIC ---
        window.addTodo = async () => {
            const txt = document.getElementById('todoInput').value;
            const prio = document.getElementById('todoPriority').value;
            if(txt) {
                await addDoc(collection(db, "todos"), { task: txt, priority: prio, created: Date.now() });
                document.getElementById('todoInput').value = '';
            }
        };

        window.loadTodos = () => {
            const q = query(collection(db, "todos"), orderBy("created", "desc"));
            onSnapshot(q, snaps => {
                const list = document.getElementById('todoList');
                list.innerHTML = "";
                snaps.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = `todo-item ${data.priority || 'medium'}`;
                    div.innerHTML = `<span>${data.task}</span> <button onclick="delTodo('${docSnap.id}')" style="background:none; border:none; color:#94a3b8; cursor:pointer;"><i class="fas fa-trash"></i></button>`;
                    list.appendChild(div);
                });
            });
        };
        window.delTodo = async (id) => deleteDoc(doc(db, "todos", id));
    </script>
