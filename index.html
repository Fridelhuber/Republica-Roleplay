<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>NexGen Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a; --sidebar-bg: #1e293b; --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #3b82f6; --text-main: #f8fafc; --danger: #ef4444; --success: #10b981;
        }

        body {
            margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color);
            color: var(--text-main); height: 100vh; display: flex; overflow: hidden;
        }

        /* --- LOGIN --- */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: var(--sidebar-bg); padding: 40px; border-radius: 16px; width: 350px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; background: rgba(0,0,0,0.3);
            border: 1px solid #334155; border-radius: 8px; color: white; box-sizing: border-box;
        }
        .login-btn {
            width: 100%; padding: 12px; background: var(--accent); border: none; color: white;
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px;
        }

        /* --- DASHBOARD --- */
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .dashboard-grid { display: grid; grid-template-columns: 300px 1fr; gap: 25px; height: calc(100vh - 100px); }
        .card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column;
        }

        /* --- PLAYER LIST --- */
        .player-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .player-item {
            padding: 12px; background: rgba(255,255,255,0.05); margin-bottom: 8px; border-radius: 8px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .player-item.selected { background: rgba(59, 130, 246, 0.3); border-left: 3px solid var(--accent); }
        
        /* STATUS DOTS */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .online { background-color: var(--success); box-shadow: 0 0 5px var(--success); }
        .offline { background-color: #64748b; }

        /* ACTIONS */
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-bottom: 10px; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-revive { background: var(--success); }
        .btn-kick { background: #f59e0b; color: black; }
        .btn-ban { background: var(--danger); }
        .btn-blue { background: var(--accent); }
        
        .hidden { display: none !important; }
        .input-mini { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; width: 100%; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--accent);">Admin Login</h2>
            <input type="email" id="email" class="login-input" placeholder="Email" value="flo.saftig526@gmail.com">
            <input type="password" id="password" class="login-input" placeholder="Passwort">
            <button class="login-btn" onclick="login()">Einloggen</button>
            <p id="login-msg" style="color: var(--danger); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="sidebar">
            <h2 style="color: var(--accent);">ADMIN</h2>
            <button class="login-btn" onclick="logout()" style="background: var(--danger); margin-top: auto;">Logout</button>
        </div>

        <div class="main-content">
            <div class="dashboard-grid">
                
                <div class="card">
                    <h3>Spieler Liste</h3>
                    <input type="text" id="playerSearch" class="login-input" placeholder="Suche (Enter für Offline DB)...">
                    <ul id="playerList" class="player-list"></ul>
                </div>

                <div class="card">
                    <h3 id="selectedPlayerName">Keiner ausgewählt</h3>
                    <input type="hidden" id="selectedPlayerId">
                    
                    <div id="actionPanel" style="opacity: 0.5; pointer-events: none;">
                        <p id="offlineMsg" style="color: var(--danger); display: none;">⚠ SPIELER IST OFFLINE</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button id="btnRevive" class="btn btn-revive" onclick="sendAction('revive')">Revive</button>
                            <button id="btnKick" class="btn btn-kick" onclick="sendAction('kick')">Kick</button>
                        </div>

                        <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

                        <label>Item geben</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="itemName" class="input-mini" placeholder="Item Name">
                            <input type="number" id="itemAmount" class="input-mini" value="1" style="width: 50px;">
                            <button id="btnItem" class="btn btn-blue" onclick="sendAction('giveitem')" style="width: auto;">GO</button>
                        </div>

                        <label>Geld geben</label>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="moneyAmount" class="input-mini" placeholder="Betrag">
                            <button id="btnMoney" class="btn btn-blue" onclick="sendAction('givemoney')" style="width: auto;">GO</button>
                        </div>

                        <button id="btnBan" class="btn btn-ban" onclick="sendAction('ban')" style="margin-top: 20px;">BANNEN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDiqf5q8xmyuBO_wTNzW_gV3t-FdZ6kYzc",
            authDomain: "battleroyalegame-a15b2.firebaseapp.com",
            projectId: "battleroyalegame-a15b2"
        };

        // SERVER URL (Dein lokaler Ordner)
        const SERVER_URL = "http://127.0.0.1:30120/admin_pannel_flo"; 
        const API_SECRET = "mein_geheimes_passwort_123";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- AUTH ---
        window.login = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
            .catch(err => document.getElementById('login-msg').innerText = "Falsches Passwort!");
        }
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                fetchPlayers();
                setInterval(fetchPlayers, 5000); // Live Update alle 5s
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        // --- PLAYER LOGIC ---
        let onlinePlayers = [];

        window.fetchPlayers = async () => {
            try {
                const res = await fetch(SERVER_URL + "/players");
                if(res.ok) {
                    onlinePlayers = await res.json();
                    // Wenn keine Suche aktiv ist, zeige nur Online Spieler
                    if(document.getElementById('playerSearch').value.length < 3) {
                        renderList(onlinePlayers);
                    }
                }
            } catch(e) { console.log("Server offline?"); }
        };

        // Suche Logik (Online + Offline DB)
        let searchTimer;
        document.getElementById('playerSearch').onkeyup = () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(async () => {
                const term = document.getElementById('playerSearch').value.toLowerCase();
                
                // 1. Online Filter
                const onlineResults = onlinePlayers.filter(p => p.name.toLowerCase().includes(term));
                
                // 2. Offline DB Suche (nur wenn > 2 Zeichen)
                let offlineResults = [];
                if(term.length > 2) {
                    try {
                        const res = await fetch(SERVER_URL + "/search_offline", {
                            method: 'POST', body: JSON.stringify({ query: term })
                        });
                        if(res.ok) offlineResults = await res.json();
                    } catch(e) {}
                }

                // Kombinieren
                renderList([...onlineResults, ...offlineResults]);
            }, 500);
        };

        function renderList(players) {
            const list = document.getElementById('playerList');
            const selectedId = document.getElementById('selectedPlayerId').value;
            list.innerHTML = "";

            if(players.length === 0) {
                list.innerHTML = "<div style='padding:20px; text-align:center; color:gray;'>Keine Spieler</div>";
                return;
            }

            players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-item';
                if(p.id == selectedId) li.classList.add('selected');

                // ENTSCHEIDUNG: Grün oder Grau?
                // p.online kommt direkt vom Server als true/false
                const dotClass = (p.online === true) ? "status-dot online" : "status-dot offline";
                const statusText = (p.online === true) ? "Online" : "Offline";

                li.innerHTML = `
                    <div><span class="${dotClass}"></span> <b>${p.name}</b> <small>(${p.id})</small></div>
                    <small style="color:#aaa">${statusText}</small>
                `;
                
                li.onclick = () => selectPlayer(p);
                list.appendChild(li);
            });
        }

        window.selectPlayer = (p) => {
            document.querySelectorAll('.player-item').forEach(el => el.classList.remove('selected'));
            // Da wir die Liste neu rendern, markieren wir es visuell vielleicht nicht sofort, 
            // aber wir speichern die ID
            document.getElementById('selectedPlayerName').innerText = p.name;
            document.getElementById('selectedPlayerId').value = p.id;

            const panel = document.getElementById('actionPanel');
            panel.style.opacity = "1"; 
            panel.style.pointerEvents = "all";

            const isOffline = (p.online !== true);
            
            // Buttons deaktivieren wenn Offline
            document.getElementById('btnRevive').disabled = isOffline;
            document.getElementById('btnKick').disabled = isOffline;
            document.getElementById('btnItem').disabled = isOffline;
            document.getElementById('btnMoney').disabled = isOffline;

            // Warnung anzeigen
            document.getElementById('offlineMsg').style.display = isOffline ? "block" : "none";
        };

        window.sendAction = async (action) => {
            const id = document.getElementById('selectedPlayerId').value;
            const payload = { secret: API_SECRET, action: action, targetId: id };
            
            // Werte für Item/Geld holen
            if(action === 'giveitem') {
                payload.item = document.getElementById('itemName').value;
                payload.amount = document.getElementById('itemAmount').value;
            }
            if(action === 'givemoney') payload.amount = document.getElementById('moneyAmount').value;

            try {
                const res = await fetch(SERVER_URL + "/command", {
                    method: 'POST', body: JSON.stringify(payload)
                });
                const data = await res.json();
                alert(data.message);
            } catch(e) { alert("Fehler: " + e); }
        }
    </script>
</body>
</html>
